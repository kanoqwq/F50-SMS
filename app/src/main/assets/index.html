<!DOCTYPE html>
<html lang="zh-cn">

<head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>F50-SMS</title>
    <style>
        body {
            position: relative;
            margin: 0;
            padding: 0;
            background-image: url('https://api.kanokano.cn/startThere/assets/bg.webp');
            background-attachment: fixed;
            background-size: cover;
        }

        ul {
            list-style: none;
            margin: 0;
            padding: 0;
        }

        .container {
            display: flex;
            flex-direction: column;
            height: 100vh;
            max-width: 1200px;
            margin: 0 auto;
            justify-content: center;
            align-items: center;
        }

        .box {
            overflow: auto;
            width: 100%;
            padding: 20px;
            border-radius: 16px;
            backdrop-filter: blur(10px);
            box-shadow: #0000004b 0px 0px 10px 0px;
            margin: 0 20px;
        }

        .deviceList {
            overflow: hidden;
            color: #fff;
        }

        .deviceList li {
            border-radius: 10px;
            background-color: #ffffff70;
            /* backdrop-filter: blur(10px); */
            padding: 4px;
            margin-bottom: 10px;
        }

        .deviceList li p {
            display: flex;
            flex-wrap: wrap;
            overflow: auto;
            margin: 0;
            padding: 10px 0;
            padding-bottom: 5px;
            border-radius: 10px;
        }

        .deviceList strong {
            display: flex;
            align-items: center;
            flex-shrink: 0;
            padding: 10px;
            background-color: rgba(255, 86, 2, 0.337);
            border-radius: 10px;
        }

        .deviceList strong {
            width: fit-content;
            box-sizing: border-box;
            margin: 5px;
            margin-top: 0;
            border: 1px solid transparent;
            transition: all 0.3s;
        }

        .deviceList strong:hover,
        .deviceList strong:active {
            border: 1px solid pink;
            box-shadow: 0 0 10px pink;
            transform: scale(1.01);
        }

        .green {
            color: rgba(40, 209, 40, 0.6);
            text-shadow: 0 0 10px rgba(255, 255, 255, 0.918);
        }

        .red {
            color: rgba(202, 41, 41, 0.6);
            text-shadow: 0 0 10px rgba(255, 255, 255, 0.918);
        }

        .blue {
            color: rgb(5, 200, 254);
            text-shadow: 0 0 10px rgba(255, 255, 255, 0.918);
        }

        .title {
            margin-top: 0;
            padding-left: 10px;
            border-left: 6px solid skyblue;
        }

        .footer {
            position: fixed;
            z-index: 0;
            width: 100%;
            left: 50%;
            bottom: 4px;
            transform: translateX(-50%);
            text-align: center;
            backdrop-filter: blur(10px);
            border-radius: 10px;
            background-color: #ffffff79;
        }

        .footer p {
            margin: 0;
            padding: 5px 15px;
        }

        .modal {
            box-sizing: border-box;
            position: fixed;
            z-index: 1;
            overflow: hidden;
            max-height: 90%;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: #ffffff82;
            backdrop-filter: blur(10px);
            padding: 20px;
            border-radius: 10px;
            opacity: 1;
            transition: all .3s;
            /* background-color: #00ffdd17; */
            box-shadow: 0 0 10px 0 #00ffdd96;
        }

        button {
            padding: 5px 10px;
            background-color: skyblue;
            border: 1px solid transparent;
            border-radius: 5px;
            color: white;
            transition: box-shadow .2s;
        }

        button:hover {
            box-shadow: 0 0 10px 0 skyblue
        }

        button:active {
            border: 1px solid pink;
        }

        input {
            border-radius: 6px;
            border: 1px solid skyblue;
        }

        .modal .content {
            overflow: auto;
            overflow-x: hidden;
            max-height: 300px;
        }

        .modal .action {
            display: flex;
            align-items: center;
            justify-content: center;
            flex-wrap: wrap;
            gap: 5px;
            background-color: #00ffdd7c;
            padding: 5px 6px;
            border-radius: 6px;
        }

        .modal .action input {
            width: 100%;
            height: 30px;
            padding: 5px;
            box-sizing: border-box;
            width: 100%;
        }

        .sms-item {
            position: relative;
            max-width: 500px;
            padding: 10px;
            margin: 10px;
            border-radius: 10px;
            background: #ffffff70;
            font-size: 14px;
        }

        .arrow {
            content: '';
            position: absolute;
            display: block;
            z-index: 111;
            top: 0;
            width: 0;
            height: 0;
            border: 15px solid;
            margin: 10px 0;
        }

        .sms-item p {
            margin: 0;
            overflow: hidden;
            word-wrap: break-word;
        }

        ::-webkit-scrollbar {
            width: 1px;
        }

        .icon {
            position: absolute;
            right: 8px;
            top: 8px;
            transition: all .3s;
        }

        .icon:hover {
            box-shadow: 0 0 10px 0 #ff000096;
        }

        .icon svg {
            fill: #ff0000c0;
        }

        #smsList {
            display: flex;
            flex-direction: column;
            width: 94%;
            max-width: 600px;
            max-height: 94%;
        }

        .deviceList {
            flex: 1;
            flex-shrink: 0;
            color: #fff;
            background-color: transparent;

        }

        .deviceList li {
            font-size: 12px;
            border-radius: 10px;
            padding: 4px;
            margin-bottom: 10px;
        }

        .deviceList li p {
            display: flex;
            flex-wrap: wrap;
            overflow: auto;
            margin: 0;
            padding: 4px 0;
            padding-bottom: 5px;
            border-radius: 10px;
        }

        .deviceList strong {
            display: flex;
            align-items: center;
            flex-shrink: 0;
            padding: 6px;
            background-color: rgba(255, 86, 2, 0.337);
            border-radius: 10px;
        }

        .deviceList strong {
            width: fit-content;
            box-sizing: border-box;
            margin: 8px;
            margin-top: 0;
            border: 1px solid transparent;
            transition: all 0.3s;
        }

        .deviceList strong:hover,
        .deviceList strong:active {
            border: 1px solid pink;
            box-shadow: 0 0 10px pink;
            transform: scale(1.01);
        }
    </style>
</head>

<body>
    <div class="container">
        <div style="flex-shrink: 0;justify-content: end;align-items: end;text-align: center;">
            <button id="SMS" class="btn" style="margin-bottom: 20px;padding: 14px;font-size: 20px;">ZTEçŸ­ä¿¡æ”¶å‘å®¢æˆ·ç«¯</button>
            <div style="margin-bottom: 20px;">
                <button id="CLEAR" class="btn" style="padding: 10px;font-size: 16px;">é€€å‡ºç™»å½•</button>
                <button id="ADB" class="btn" style="padding: 10px;font-size: 16px;">å¼€å¯ADBè°ƒè¯•</button>
                <button id="PERF" class="btn" style="padding: 10px;font-size: 16px;">å¼€å¯æ€§èƒ½æ¨¡å¼</button>
            </div>
        </div>
        <div style="flex-shrink:0;">
            <div class="title" style="margin: 6px 0 ;"><strong>æœºå™¨çŠ¶æ€</strong></div>
            <ul class="deviceList" id="STATUS">
            </ul>
        </div>
        <div class="modal" id="tokenModal" style="display: none;">
            <div class="title">è¯·è¾“å…¥å¯†ç </div>
            <div class="content" style="padding-top: 15px;display: flex;flex-direction: column;align-items: center;">
                <input id="IPInput" placeholder="ipåœ°å€" value="localhost:8090" type="text"
                    style="display: none;margin:0 4px;margin-bottom: 20px;height: 30px;">
                <input id="tokenInput" placeholder="ç®¡ç†å¯†ç " type="password" value=""
                    style="margin:0 4px;margin-bottom: 20px;height: 30px;">
            </div>
            <div class="btn" style="text-align: right;">
                <button onclick="onTokenConfirm()">ç¡®è®¤</button>
                <button onclick="closeModal('#tokenModal')">å–æ¶ˆ</button>
            </div>
        </div>
        <div class="modal" id="smsList" style="display: none;">
            <div class="title" style="margin-bottom: 6px;">çŸ­ä¿¡åˆ—è¡¨</div>
            <div class="action" style="margin-top: 10px;background-color: #00ffdd17;box-shadow: 0 0 10px 0 #00ffdd96;">
                <span>æ”¶ä»¶äººï¼š</span>
                <input id="PhoneInput" type="number" style="flex: 1;margin-right: 6px"></input>
            </div>
            <div class="content" id="content" style="flex: 1;">
                <ul id="sms-list">
                </ul>
            </div>
            <div class="action" style="background-color: #00ffdd17;box-shadow: 0 0 10px 0 #00ffdd96;">
                <input id="SMSInput" type="text" style="flex: 1;margin-right: 6px"></input>
                <div class="btn" style="height: 30px;min-width: 103px;">
                    <button onclick="sendSMS()">å‘é€</button>
                    <button onclick="closeModal('#smsList')">å…³é—­</button>
                </div>
            </div>
        </div>
    </div>
    <div class="footer">
        <p>Made by <a href="https://github.com/kanoqwq" target="_blank">MiniKano</a> with love â¤ï¸</p>
    </div>
    <script>
        function SHA256(e) { function t(e, t) { var n = (65535 & e) + (65535 & t); return (e >> 16) + (t >> 16) + (n >> 16) << 16 | 65535 & n } function n(e, t) { return e >>> t | e << 32 - t } function r(e, t) { return e >>> t } function o(e, t, n) { return e & t ^ ~e & n } function i(e, t, n) { return e & t ^ e & n ^ t & n } function a(e) { return n(e, 2) ^ n(e, 13) ^ n(e, 22) } function s(e) { return n(e, 6) ^ n(e, 11) ^ n(e, 25) } function c(e) { return n(e, 7) ^ n(e, 18) ^ r(e, 3) } function u(e) { return n(e, 17) ^ n(e, 19) ^ r(e, 10) } var l = 8, d = 1; return e = function (e) { e = e.replace(/\\r\\n/g, "\\n"); for (var t = "", n = 0; n < e.length; n++) { var r = e.charCodeAt(n); r < 128 ? t += String.fromCharCode(r) : r > 127 && r < 2048 ? (t += String.fromCharCode(r >> 6 | 192), t += String.fromCharCode(63 & r | 128)) : (t += String.fromCharCode(r >> 12 | 224), t += String.fromCharCode(r >> 6 & 63 | 128), t += String.fromCharCode(63 & r | 128)) } return t }(e), function (e) { for (var t = d ? "0123456789ABCDEF" : "0123456789abcdef", n = "", r = 0; r < 4 * e.length; r++)n += t.charAt(e[r >> 2] >> 8 * (3 - r % 4) + 4 & 15) + t.charAt(e[r >> 2] >> 8 * (3 - r % 4) & 15); return n }(function (e, n) { var r, l, d, p, h, f, m, g, _, b, v, $, S = new Array(1116352408, 1899447441, 3049323471, 3921009573, 961987163, 1508970993, 2453635748, 2870763221, 3624381080, 310598401, 607225278, 1426881987, 1925078388, 2162078206, 2614888103, 3248222580, 3835390401, 4022224774, 264347078, 604807628, 770255983, 1249150122, 1555081692, 1996064986, 2554220882, 2821834349, 2952996808, 3210313671, 3336571891, 3584528711, 113926993, 338241895, 666307205, 773529912, 1294757372, 1396182291, 1695183700, 1986661051, 2177026350, 2456956037, 2730485921, 2820302411, 3259730800, 3345764771, 3516065817, 3600352804, 4094571909, 275423344, 430227734, 506948616, 659060556, 883997877, 958139571, 1322822218, 1537002063, 1747873779, 1955562222, 2024104815, 2227730452, 2361852424, 2428436474, 2756734187, 3204031479, 3329325298), y = new Array(1779033703, 3144134277, 1013904242, 2773480762, 1359893119, 2600822924, 528734635, 1541459225), C = new Array(64); e[n >> 5] |= 128 << 24 - n % 32, e[15 + (n + 64 >> 9 << 4)] = n; for (var _ = 0; _ < e.length; _ += 16) { r = y[0], l = y[1], d = y[2], p = y[3], h = y[4], f = y[5], m = y[6], g = y[7]; for (var b = 0; b < 64; b++)C[b] = b < 16 ? e[b + _] : t(t(t(u(C[b - 2]), C[b - 7]), c(C[b - 15])), C[b - 16]), v = t(t(t(t(g, s(h)), o(h, f, m)), S[b]), C[b]), $ = t(a(r), i(r, l, d)), g = m, m = f, f = h, h = t(p, v), p = d, d = l, l = r, r = t(v, $); y[0] = t(r, y[0]), y[1] = t(l, y[1]), y[2] = t(d, y[2]), y[3] = t(p, y[3]), y[4] = t(h, y[4]), y[5] = t(f, y[5]), y[6] = t(m, y[6]), y[7] = t(g, y[7]) } return y }(function (e) { for (var t = Array(), n = (1 << l) - 1, r = 0; r < e.length * l; r += l)t[r >> 5] |= (e.charCodeAt(r / l) & n) << 24 - r % 32; return t }(e), e.length * l)) }
        function gsmEncode(text) { function encodeText(text) { let encoded = []; for (let i = 0; i < text.length; i++) { const char = text[i]; const codePoint = char.codePointAt(0); if (codePoint <= 0xFFFF) { encoded.push((codePoint >> 8) & 0xFF); encoded.push(codePoint & 0xFF) } else { const highSurrogate = 0xD800 + ((codePoint - 0x10000) >> 10); const lowSurrogate = 0xDC00 + ((codePoint - 0x10000) & 0x3FF); encoded.push((highSurrogate >> 8) & 0xFF); encoded.push(highSurrogate & 0xFF); encoded.push((lowSurrogate >> 8) & 0xFF); encoded.push(lowSurrogate & 0xFF) } } return encoded } function toHexString(byteArray) { return byteArray.map(byte => byte.toString(16).padStart(2, '0')).join('') } const encodedBytes = encodeText(text); return toHexString(encodedBytes) }

        //æ³¨æ„ï¼Œå¦‚æœæ˜¯åœ¨f50æœ¬æœºå†…å‘èµ·è¯·æ±‚ï¼Œè¯·å°†è¯·æ±‚ç«¯å£æ›´æ”¹ä¸º8080
        let KANO_baseURL = 'localhost:8090'
        let KANO_PASSWORD = null

        //ç™»å½•
        const common_headers = {
            "referer": 'http://' + KANO_baseURL + '/index.html',
            "host": KANO_baseURL,
            "origin": 'http://' + KANO_baseURL,
        }

        const login = async () => {
            try {

                const { LD } = await getLD()
                if (!LD) throw new Error('æ— æ³•è·å–LD')

                const pwd = SHA256(SHA256(KANO_PASSWORD) + LD)
                const body = new URLSearchParams({
                    "goformId": "LOGIN",
                    "isTest": "false",
                    "password": pwd
                })
                const res = await fetch("http://" + KANO_baseURL + "/goform/goform_set_cmd_process", {
                    method: "POST",
                    headers: {
                        ...common_headers,
                        "content-Type": "application/x-www-form-urlencoded; charset=UTF-8",
                    },
                    body
                })
                const res_data = await res.json()
                if (res_data == undefined || res_data == null || res_data.result == '3' || res_data.result == 3) {
                    return null
                }
                return res.headers.get('kano-cookie').split(';')[0]
            }
            catch {
                return null
            }
        }

        const logout = async (cookie) => {
            const AD = await processAD(cookie)
            const body = new URLSearchParams({
                "goformId": "LOGOUT",
                "isTest": "false",
                AD: AD
            })
            const res = await fetch("http://" + KANO_baseURL + "/goform/goform_set_cmd_process", {
                method: "POST",
                headers: {
                    ...common_headers,
                    "content-Type": "application/x-www-form-urlencoded; charset=UTF-8",
                    // "content-Length": body.toString().length
                },
                body
            })
            return await res.text()
        }

        const getLD = async () => {
            const res = await fetch("http://" + KANO_baseURL + "/goform/goform_get_cmd_process?isTest=false&cmd=LD&_=" + Date.now(), {
                method: "GET",
                headers: {
                    ...common_headers,
                }
            })
            return await res.json()
        }


        const getRD = async (cookie) => {
            if (!cookie) throw new Error('è¯·æä¾›cookie')
            const res = await fetch("http://" + KANO_baseURL + "/goform/goform_get_cmd_process?isTest=false&cmd=RD&_=" + Date.now(), {
                method: "GET",
                headers: {
                    ...common_headers,
                    "Cookie": cookie
                }
            })
            return await res.json()
        }

        const getUFIInfo = async () => {
            const res = await fetch("http://" + KANO_baseURL + "/goform/goform_get_cmd_process?isTest=false&cmd=Language,cr_version,wa_inner_version&multi_data=1&_=" + Date.now(), {
                method: "GET",
                headers: {
                    ...common_headers
                }
            })
            return await res.json()
        }

        const processAD = async (cookie) => {
            const { wa_inner_version, cr_version } = await getUFIInfo()
            if (!wa_inner_version || !cr_version) throw new Error('æ— æ³•è·å–ç‰ˆæœ¬ä¿¡æ¯')
            const parsedInfo = SHA256(wa_inner_version + cr_version)
            const { RD } = await getRD(cookie)
            const AD = SHA256(parsedInfo + RD)
            return AD
        }

        const postData = async (cookie, data = {}) => {
            const AD = await processAD(cookie)
            const body = new URLSearchParams({
                ...data,
                isTest: false,
                "AD": AD
            })
            const res = await fetch("http://" + KANO_baseURL + "/goform/goform_set_cmd_process", {
                method: "POST",
                headers: {
                    ...common_headers,
                    "Content-Type": "application/x-www-form-urlencoded",
                    "Cookie": cookie,
                    // "content-Length": body.toString().length
                },
                body
            })
            return res
        }
        const getData = async (data = new URLSearchParams({})) => {
            data.append('isTest', 'false')
            data.append('_', Date.now())
            const res = await fetch("http://" + KANO_baseURL + "/goform/goform_get_cmd_process?" + data.toString(), {
                method: "GET",
                headers: {
                    ...common_headers,
                    "Content-Type": "application/x-www-form-urlencoded",
                },
            })
            return await res.json()
        }

        const reboot = async (cookie) => {
            const res = await postData(cookie, {
                goformId: 'REBOOT_DEVICE',
            })
            return res
        }

        // å‘é€çŸ­ä¿¡
        const sendSms_UFI = async ({ content, number }) => {
            if (!content) throw new Error('è¯·æä¾›çŸ­ä¿¡å†…å®¹')
            if (!number) throw new Error('è¯·æä¾›æ‰‹æœºå·')
            const cookie = await login()
            const res = await postData(cookie, {
                goformId: 'SEND_SMS',
                Number: number,
                MessageBody: gsmEncode(content)
            })
            await logout(cookie)
            return await res.json()
        }

        //åˆ é™¤çŸ­ä¿¡
        const removeSmsById = async (id) => {
            if (!id) throw new Error('è¯·æä¾›çŸ­ä¿¡id')
            const cookie = await login()
            const res = await postData(cookie, {
                goformId: 'DELETE_SMS',
                msg_id: id,
                notCallback: true
            })
            await logout(cookie)
            return await res.json()
        }

        //è·å–çŸ­ä¿¡åˆ—è¡¨ï¼ˆbase64ç¼–ç ï¼‰
        const getSmsInfo = async () => {
            const params = new URLSearchParams()
            params.append('_', Date.now().toString())
            const res = await fetch("http://" + KANO_baseURL + "/goform/goform_get_cmd_process?multi_data=1&isTest=false&cmd=sms_data_total&page=0&data_per_page=500&mem_store=1&tags=100&order_by=order by id desc&" + params, {
                headers: {
                    ...common_headers
                }
            })
            return await res.json()
        }

        const getUFIData = async () => {
            try {
                const params = new URLSearchParams()
                params.append('_', Date.now().toString())
                const cmd = 'rssi,Z5g_rsrp,wifi_access_sta_num,loginfo,data_volume_alert_percent,data_volume_limit_size,realtime_rx_thrpt,realtime_tx_thrpt,realtime_time,monthly_tx_bytes,monthly_rx_bytes,monthly_time,network_type,network_provider'
                const res = await fetch("http://" + KANO_baseURL + "/goform/goform_get_cmd_process?multi_data=1&isTest=false&cmd=" + cmd + "&" + params, {
                    headers: {
                        ...common_headers
                    }
                })
                return await res.json()

            } catch {
                return null
            }
        }
    </script>
    <script>
        let smsSender = null

        function kano_getSignalEmoji(strength) {
            const signals = ["ğŸ“¶ â¬œâ¬œâ¬œâ¬œ", "ğŸ“¶ ğŸŸ¨â¬œâ¬œâ¬œ", "ğŸ“¶ ğŸŸ©ğŸŸ¨â¬œâ¬œ", "ğŸ“¶ ğŸŸ©ğŸŸ©ğŸŸ¨â¬œ", "ğŸ“¶ ğŸŸ©ğŸŸ©ğŸŸ©ğŸŸ¨", "ğŸ“¶ ğŸŸ©ğŸŸ©ğŸŸ©ğŸŸ©"];
            return signals[Math.max(0, Math.min(strength, 5))]; // ç¡®ä¿è¾“å…¥åœ¨ 0-5 ä¹‹é—´
        }
        function kano_formatTime(seconds) {
            if (seconds < 60) {
                return `${seconds} ç§’`;
            } else if (seconds < 3600) {
                return `${(seconds / 60).toFixed(1)} åˆ†é’Ÿ`;
            } else {
                return `${(seconds / 3600).toFixed(1)} å°æ—¶`;
            }
        }
        function formatBytes(bytes) {
            if (bytes === 0) return '0 Byte';

            const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB', 'PB', 'EB', 'ZB', 'YB'];
            const i = Math.floor(Math.log(bytes) / Math.log(1024));
            return (bytes / Math.pow(1024, i)).toFixed(2) + ' ' + sizes[i];
        }
        // KANO_INTERFACE.setValue("hello world")
        function decodeBase64(base64String) {
            // å°†Base64å­—ç¬¦ä¸²åˆ†æˆæ¯64ä¸ªå­—ç¬¦ä¸€ç»„
            const padding = base64String.length % 4 === 0 ? 0 : 4 - (base64String.length % 4)
            base64String += '='.repeat(padding)

            // ä½¿ç”¨atob()å‡½æ•°è§£ç Base64å­—ç¬¦ä¸²
            const binaryString = window.atob(base64String)

            // å°†äºŒè¿›åˆ¶å­—ç¬¦ä¸²è½¬æ¢ä¸ºTypedArray
            const bytes = new Uint8Array(binaryString.length)
            for (let i = 0; i < binaryString.length; i++) bytes[i] = binaryString.charCodeAt(i)

            // å°†TypedArrayè½¬æ¢ä¸ºå­—ç¬¦ä¸²
            return new TextDecoder('utf-8').decode(bytes)
        }

        function createToast(text, color, delay = 3000) {
            const toastEl = document.createElement('div')
            toastEl.style.position = 'fixed'
            toastEl.style.padding = '10px'
            toastEl.style.top = '20px'
            toastEl.style.right = '50%'
            toastEl.style.transform = 'translateX(50%)'
            toastEl.style.color = color || 'while'
            toastEl.style.backgroundColor = '#ffffff54'
            toastEl.style.transition = `opacity .2s`
            toastEl.style.opacity = `0`
            toastEl.style.boxShadow = '0 0 10px 0 #00ffdd96'
            toastEl.style.fontWeight = 'bold'
            toastEl.style.backdropFilter = 'blur(10px)'
            toastEl.style.borderRadius = '6px'
            toastEl.innerHTML = text;
            const id = 'toastkano'
            toastEl.setAttribute('class', id);
            const toasts = document.querySelectorAll('.toastkano')
            document.body.appendChild(toastEl)
            setTimeout(() => {
                toastEl.style.opacity = `1`
            }, 0);
            if (toasts.length) {
                const top = toasts[toasts.length - 1].getBoundingClientRect().top
                const height = toastEl.getBoundingClientRect().height
                toastEl.style.top = top + height + 10 + 'px'
            }
            let timer = null
            setTimeout(() => {
                toastEl.style.opacity = `0`
                clearTimeout(timer)
                timer = setTimeout(() => {
                    document.body.removeChild(toastEl)
                }, 200);
            }, delay);
        }
        function closeModal(txt, time = 300) {
            if (txt == '#smsList') smsSender && smsSender()
            let el = document.querySelector(txt)
            if (!el) return
            el.style.opacity = 0
            setTimeout(() => {
                el.style.display = 'none'
            }, time)
        }
        function showModal(txt, time = 300) {
            let el = document.querySelector(txt)
            if (!el) return
            el.style.opacity = 0
            el.style.display = ''
            setTimeout(() => {
                el.style.opacity = 1
            }, 10)
        }

        const debounce = (func, delay) => {
            let timer;
            return function (...args) {
                if (timer) clearTimeout(timer);
                timer = setTimeout(() => {
                    func.apply(this, args);
                }, delay);
            };
        };
        const onTokenConfirm = debounce(async () => {
            let tkInput = document.querySelector('#tokenInput')
            let password = tkInput && (tkInput.value)
            if (!password || !password?.trim()) return createToast('è¯·è¾“å…¥å¯†ç ï¼', 'red')
            KANO_PASSWORD = password.trim()
            const cookie = await login()
            if (!cookie) {
                createToast(`ç™»å½•å¤±è´¥ï¼Œè¯·æ£€æŸ¥å¯†ç `, 'red')
                tkInput.value = ''
                out()
                return null
            }
            createToast('ç™»å½•æˆåŠŸï¼', 'green')
            localStorage.setItem('kano_sms_pwd', password.trim())
            
            closeModal('#tokenModal')
            handlerADBStatus()
            handlerPerformaceStatus()
        }, 200)

        function requestInterval(callback, interval) {
            let lastTime = 0;
            let timeoutId = null;

            function loop(timestamp) {
                if (!lastTime) lastTime = timestamp; // åˆå§‹åŒ–ä¸Šæ¬¡æ—¶é—´
                const delta = timestamp - lastTime; // è®¡ç®—æ—¶é—´å·®

                if (delta >= interval) {
                    callback(); // æ‰§è¡Œä»»åŠ¡
                    lastTime = timestamp; // æ›´æ–°ä¸Šæ¬¡æ—¶é—´
                }

                timeoutId = requestAnimationFrame(loop); // ç»§ç»­è¯·æ±‚ä¸‹ä¸€å¸§
            }

            timeoutId = requestAnimationFrame(loop); // å¯åŠ¨åŠ¨ç”»å¾ªç¯

            // è¿”å›æ¸…é™¤å‡½æ•°
            return () => cancelAnimationFrame(timeoutId);
        }

        let timer_out = null
        function out() {
            smsSender && smsSender()
            localStorage.removeItem('kano_sms_pwd')
            closeModal('#smsList')
            clearTimeout(timer_out)
            timer_out = setTimeout(() => {
                showModal('#tokenModal')
            }, 320);
        }

        var initRequestData = () => {
            const PWD = localStorage.getItem('kano_sms_pwd')
            if (!PWD) {
                return false
            }
            KANO_PASSWORD = PWD
            return true
        }

        var getSms = async () => {
            if (!initRequestData()) {
                out()
                return null
            }
            try {
                let res = await getSmsInfo()
                if (!res) {
                    out()
                    createToast(res.error, 'red')
                    return null
                }
                return res.messages
            } catch {
                out()
                return null
            }
        }

        let isDisabledSendSMS = false
        var sendSMS = async () => {
            const SMSInput = document.querySelector('#SMSInput')
            const PhoneInput = document.querySelector('#PhoneInput')
            if (SMSInput && SMSInput.value && SMSInput.value.trim()
                && PhoneInput && PhoneInput.value && Number(PhoneInput.value.trim())
            ) {
                try {
                    if (isDisabledSendSMS) return createToast('è¯·ä¸è¦é¢‘ç¹å‘é€ï¼', 'red')
                    const content = SMSInput.value.trim()
                    const number = PhoneInput.value.trim()
                    isDisabledSendSMS = true
                    const res = await sendSms_UFI({ content, number })
                    if (res && res.result == 'success') {
                        SMSInput.value = ''
                        createToast('å‘é€æˆåŠŸï¼', 'green')
                        handleSmsRender()
                    } else {
                        createToast((res && res.message) ? res.message : 'å‘é€å¤±è´¥', 'red')
                    }
                } catch {
                    createToast('å‘é€å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œå’Œå¯†ç ', 'red')
                    out()
                }
                isDisabledSendSMS = false
            } else {
                createToast('è¯·è¾“å…¥æ‰‹æœºå·å’Œå†…å®¹', 'red')
            }
        }

        const deleteState = new Map();
        const deleteSMS = async (id) => {
            const message = document.querySelector(`#message${id}`);

            if (!message) return;

            // è·å–å½“å‰ id çš„åˆ é™¤çŠ¶æ€
            let state = deleteState.get(id) || { confirmCount: 0, timer: null, isDeleting: false };

            if (state.isDeleting) return; // æ­£åœ¨åˆ é™¤æ—¶ç¦æ­¢æ“ä½œ

            state.confirmCount += 1;
            message.style.display = '';

            // æ¸…é™¤ä¹‹å‰çš„è®¡æ—¶å™¨ï¼Œé‡æ–°è®¾ç½® 2 ç§’åé‡ç½®çŠ¶æ€
            clearTimeout(state.timer);
            state.timer = setTimeout(() => {
                state.confirmCount = 0;
                message.style.display = 'none';
                deleteState.set(id, state);
            }, 2000);

            deleteState.set(id, state);

            if (state.confirmCount < 2) return; // ç¬¬ä¸€æ¬¡ç‚¹å‡»æ—¶ä»…æç¤º

            // è¿›å…¥åˆ é™¤çŠ¶æ€ï¼Œé˜²æ­¢é‡å¤ç‚¹å‡»
            state.isDeleting = true;
            deleteState.set(id, state);

            try {
                const res = await removeSmsById(id);
                if (res?.result === 'success') {
                    createToast('åˆ é™¤æˆåŠŸï¼', 'green');
                    handleSmsRender();
                } else {
                    createToast(res?.message || 'åˆ é™¤å¤±è´¥', 'red');
                }
            } catch {
                createToast('æ“ä½œå¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œå’Œå¯†ç ', 'red');
            }

            // åˆ é™¤å®Œæˆåï¼Œæ¸…ç†çŠ¶æ€
            deleteState.delete(id);
        };

        let isFirstRender = true
        let lastRequestSmsIds = null
        let handleSmsRender = async () => {
            let list = document.querySelector('#sms-list')
            if (!list) createToast('æ²¡æœ‰æ‰¾åˆ°çŸ­ä¿¡åˆ—è¡¨èŠ‚ç‚¹', 'red')
            if (isFirstRender) {
                list.innerHTML = ` <li><h2 style="padding: 30px;text-align:center">Loading...</h2></li>`
            }
            isFirstRender = false
            showModal('#smsList')
            let res = await getSms()
            if (res && res.length) {
                //é˜²æ­¢é‡å¤æ¸²æŸ“
                let ids = res.map(item => item.id).join('')
                if (ids === lastRequestSmsIds) return
                lastRequestSmsIds = ids
                const dateStrArr = ['å¹´', 'æœˆ', 'æ—¥', ':', ':', '']
                res.sort((a, b) => {
                    let date_a = a.date.split(',')
                    let date_b = b.date.split(',')
                    date_a.pop()
                    date_b.pop()
                    return Number(date_b.join('')) - Number(date_a.join(''))
                })
                list.innerHTML = res.map(item => {
                    let date = item.date.split(',')
                    date.pop()
                    date = date.map((item, index) => {
                        return item + dateStrArr[index]
                    }).join('')
                    return `<li class="sms-item" style="${item.tag != '2' ? 'background-color:#00800063;margin-left:15px' : 'background-color:#ffc0cb82;margin-right:15px'}">
                                        <div class="arrow" style="${item.tag == '2' ? 'right:-30px;border-color: transparent transparent transparent #ffc0cb82' : 'left:-30px;border-color: transparent #00800063 transparent transparent'}"></div>
                                        <div class="icon" onclick="deleteSMS(${item.id})">
                                            <span id="message${item.id}" style="display:none;color:red;position: absolute;width: 100px;top: 6px;right: 20px;">ç¡®å®šè¦åˆ é™¤å—ï¼Ÿ</span>
                                            <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" t="1742373390977" class="icon" viewBox="0 0 1024 1024" version="1.1" p-id="2837" width="16" height="16"><path d="M848 144H608V96a48 48 0 0 0-48-48h-96a48 48 0 0 0-48 48v48H176a48 48 0 0 0-48 48v48h768v-48a48 48 0 0 0-48-48zM176 928a48 48 0 0 0 48 48h576a48 48 0 0 0 48-48V288H176v640z m480-496a48 48 0 1 1 96 0v400a48 48 0 1 1-96 0V432z m-192 0a48 48 0 1 1 96 0v400a48 48 0 1 1-96 0V432z m-192 0a48 48 0 1 1 96 0v400a48 48 0 1 1-96 0V432z" fill="" p-id="2838"/></svg>
                                        </div>
                                        <p style="color:purple;font-size:16px;margin:4px 0">${item.number}</p>
                                        <p>${decodeBase64(item.content)}</p>
                                        <p style="text-align:right;color:purple;margin-top:4px">${date}</p >
                                    </li > `
                }).join('')
            } else {
                if (!res) {
                    out()
                }
                list.innerHTML = ` <li> <h2 style="padding: 30px;text-align:center">æ²¡æœ‰çŸ­ä¿¡</h2></li >`
            }
        }

        let handlerStatusRender = async () => {
            const res = await getUFIData()

            if (!res) {
                createToast('è·å–çŠ¶æ€å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œ', 'red')
                out()
                return
            }
            if (res) {
                const status = document.querySelector('#STATUS')
                let html = ''
                html += '<li style="padding-top: 15px;">'
                html += `<p>
                        ${res.network_type ? `<strong  class="green">èœ‚çªçŠ¶æ€ï¼š${res.network_provider} ${res.network_type}</strong>` : ''}
                        ${res.wifi_access_sta_num ? `<strong  class="blue">è®¾å¤‡æ•°ï¼š${res.wifi_access_sta_num}</strong>` : ''}
                        ${res.rssi ? `<strong  class="green">èœ‚çªä¿¡å·å¼ºåº¦ï¼š${kano_getSignalEmoji(res.rssi)}</strong>` : ''}
                        ${res.realtime_time ? `<strong  class="blue">è¿æ¥æ—¶é•¿ï¼š${kano_formatTime(Number(res.realtime_time))}${res.monthly_time ? '&nbsp;<span style="color:white">/</span>&nbsp;æ€»æ—¶é•¿(æœˆ): ' + kano_formatTime(Number(res.monthly_time)) : ''}</strong>` : ''}
                        ${res.realtime_tx_thrpt != undefined && res.realtime_rx_thrpt != undefined ? `<strong  class="blue">å½“å‰ç½‘é€Ÿ: â¬‡ï¸ ${formatBytes(Number((res.realtime_rx_thrpt)))}/S â¬†ï¸ ${formatBytes(Number((res.realtime_tx_thrpt)))}/S</strong>` : ''}
                        ${(res.monthly_tx_bytes && res.monthly_rx_bytes) ? `<strong  class="blue">å·²ç”¨æµé‡ï¼š<span class="red">${Number((res.monthly_tx_bytes + res.monthly_rx_bytes) / 1024 / 1024 / 1024).toFixed(2)} GB</span>${res.data_volume_limit_size ? '&nbsp;<span style="color:white">/</span>&nbsp;æ€»æµé‡ï¼š' + res.data_volume_limit_size.split('_')[0] + ' GB' : ''}</strong>` : ''}
                   </p>`
                html += `</li >`
                status && (status.innerHTML = html)
            }
        }
        handlerStatusRender()
        requestInterval(() => handlerStatusRender(), 800)

        //æ£€æŸ¥usbè°ƒè¯•çŠ¶æ€
        let handlerADBStatus = async () => {
            const btn = document.querySelector('#ADB')
            if (!initRequestData()) {
                btn.style.backgroundColor = 'gray'
                out()
                return null
            }
            let res = await getData(new URLSearchParams({
                cmd: 'usb_port_switch'
            }))
            btn.onclick = async () => {
                try {
                    const cookie = await login()
                    if (!cookie) {
                        createToast('ç™»å½•å¤±è´¥ï¼Œè¯·æ£€æŸ¥å¯†ç ', 'red')
                        out()
                        return null
                    }
                    res = await (await postData(cookie, {
                        goformId: 'USB_PORT_SETTING',
                        usb_port_switch: res.usb_port_switch == '1' ? '0' : '1'
                    })).json()
                    if (res.result == 'success') {
                        createToast('æ“ä½œæˆåŠŸï¼', 'green')
                        await handlerADBStatus()
                    } else {
                        createToast('æ“ä½œå¤±è´¥ï¼', 'red')
                    }
                } catch (e) {
                    createToast(e.message)
                }
            }
            btn.innerHTML = res.usb_port_switch == '1' ? 'å…³é—­USBè°ƒè¯•' : 'å¼€å¯USBè°ƒè¯•'
            btn.style.backgroundColor = res.usb_port_switch == '1' ? '#018AD8' : ''

        }
        handlerADBStatus()

        //æ£€æŸ¥æ€§èƒ½æ¨¡å¼çŠ¶æ€
        let handlerPerformaceStatus = async () => {
            const btn = document.querySelector('#PERF')
            if (!initRequestData()) {
                btn.style.backgroundColor = 'gray'
                out()
                return null
            }
            let res = await getData(new URLSearchParams({
                cmd: 'performance_mode'
            }))
            btn.innerHTML = res.performance_mode == '1' ? 'å…³é—­æ€§èƒ½æ¨¡å¼' : 'å¼€å¯æ€§èƒ½æ¨¡å¼'
            btn.style.backgroundColor = res.performance_mode == '1' ? '#018AD8' : ''
            btn.onclick = async () => {
                try {
                    const cookie = await login()
                    if (!cookie) {
                        createToast('ç™»å½•å¤±è´¥ï¼Œè¯·æ£€æŸ¥å¯†ç ', 'red')
                        out()
                        return null
                    }
                    res = await (await postData(cookie, {
                        goformId: 'PERFORMANCE_MODE_SETTING',
                        performance_mode: res.performance_mode == '1' ? '0' : '1'
                    })).json()
                    if (res.result == 'success') {
                        createToast('æ“ä½œæˆåŠŸï¼Œé‡å¯ç”Ÿæ•ˆï¼', 'green')
                        await handlerPerformaceStatus()
                    } else {
                        createToast('æ“ä½œå¤±è´¥ï¼', 'red')
                    }
                } catch (e) {
                    createToast(e.message)
                }
            }
        }
        handlerPerformaceStatus()

        function init() {
            smsSender && smsSender()
            if (!localStorage.getItem('kano_sms_pwd')) {
                showModal('#tokenModal')
            } else {
                isFirstRender = true
                lastRequestSmsIds = null
                handleSmsRender()
                smsSender = requestInterval(() => handleSmsRender(), 2000)
            }
        }
        // init()
        var smsBtn = document.querySelector('#SMS')
        smsBtn.onclick = init

        var clearBtn = document.querySelector('#CLEAR')
        clearBtn.onclick = () => {
            isFirstRender = true
            lastRequestSmsIds = null
            localStorage.removeItem('kano_sms_pwd')
            handlerADBStatus()
            handlerPerformaceStatus()
            createToast('æ‚¨å·²é€€å‡ºç™»å½•', 'green')
            showModal('#tokenModal')
        }
    </script>
</body>

</html>